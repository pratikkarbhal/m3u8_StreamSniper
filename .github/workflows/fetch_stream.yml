name: Fetch Stream URL

on:
  workflow_dispatch:
    inputs:
      url:
        description: "The URL to scrape for m3u8 links (override default)"
        required: true
        default: "https://news.abplive.com/live-tv"

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Google Chrome (stable)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y wget gnupg2 ca-certificates unzip
          wget -q -O /tmp/google-chrome-stable_current_amd64.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get install -y /tmp/google-chrome-stable_current_amd64.deb || sudo dpkg -i /tmp/google-chrome-stable_current_amd64.deb || true
          # show chrome version
          google-chrome --version || true

      - name: Run Selenium script
        env:
          TARGET_URL: ${{ github.event.inputs.url }}
        run: |
          echo -e "\033[1;36mðŸŒ€ Running Selenium Script... ðŸŒ€\033[0m"
          python fetch_stream.py | tee puppeteer_output.txt

      - name: Display captured .m3u8 URLs
        run: |
          echo -e "\033[1;33m============================\033[0m"
          echo -e "\033[1;35m Scrape Results: \033[0m"
          echo -e "\033[1;33m============================\033[0m"
          cat puppeteer_output.txt || true
          echo -e "\033[1;33m============================\033[0m"
          grep 'Found .m3u8 URL:' puppeteer_output.txt || echo -e "\033[1;31mNo 'Found' lines in console output.\033[0m"
